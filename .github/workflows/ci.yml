name: Build and Verify

on:
  push:
  pull_request:

jobs:
  configure:
    name: Konfigurowanie CMake
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S . -B build

  build:
    name: Kompilowanie
    runs-on: ubuntu-latest
    needs: configure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build
        run: cmake --build build

  run:
    name: Czy program się uruchamia bez błędu?
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build
        run: cmake --build build

      - name: Run program
        run: ./build/zaliczenie2

  validate_output:
    name: Czy output z programu zgadza się z zadaniem?
    runs-on: ubuntu-latest
    needs: run

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build
        run: cmake --build build

      - name: Run program
        id: run_program
        run: |
          set -euo pipefail
          OUTPUT=$(./build/zaliczenie2)
          echo "Program output: $OUTPUT"
          {
            echo "output<<EOF"
            echo "$OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Validate output format
        run: |
          set -euo pipefail
          OUTPUT="${{ steps.run_program.outputs.output }}"
          EXPECTED_BRANCH="$GITHUB_REF_NAME"
          NAME_FROM_BRANCH="${EXPECTED_BRANCH#Zaliczenie2-}"

          fail() {
            echo "$1"
            echo "Actual output:"
            printf "%s\n" "$OUTPUT"
            exit 1
          }

          if [[ -z "$OUTPUT" ]]; then
            fail "Output is empty"
          fi

          mapfile -t LINES <<< "$OUTPUT"

          if [[ ${#LINES[@]} -ne 5 ]]; then
            echo "Output must contain exactly 5 lines"
            echo "Expected format:"
            echo "=== SYSTEM STATUS ==="
            echo "Engineer: ${NAME_FROM_BRANCH}"
            echo "Branch: ${EXPECTED_BRANCH}"
            echo "Uptime: <uptime>"
            echo "Running Processes: <count>"
            echo "Actual output:"
            printf "%s\n" "$OUTPUT"
            exit 1
          fi

          if [[ "${LINES[0]}" != "=== SYSTEM STATUS ===" ]]; then
            fail "First line must be '=== SYSTEM STATUS ==='"
          fi

          if [[ "${LINES[1]}" != "Engineer: ${NAME_FROM_BRANCH}" ]]; then
            fail "Second line must be 'Engineer: ${NAME_FROM_BRANCH}'"
          fi

          if [[ "${LINES[2]}" != "Branch: ${EXPECTED_BRANCH}" ]]; then
            fail "Third line must be 'Branch: ${EXPECTED_BRANCH}'"
          fi

          if [[ "${LINES[3]}" =~ ^Uptime:\ (.+)$ ]]; then
            UPTIME_FROM_OUTPUT="${BASH_REMATCH[1]}"
            if [[ -z "$UPTIME_FROM_OUTPUT" ]]; then
              fail "Uptime is empty"
            fi
          else
            fail "Fourth line must match 'Uptime: <uptime>'"
          fi

          if [[ "${LINES[4]}" =~ ^Running\ Processes:\ ([0-9]+)$ ]]; then
            PROCESSES_FROM_OUTPUT="${BASH_REMATCH[1]}"
            if [[ -z "$PROCESSES_FROM_OUTPUT" ]]; then
              fail "Running Processes is empty"
            fi
          else
            fail "Fifth line must match 'Running Processes: <count>'"
          fi

  validate_branch:
    name: Czy branch ma odpowiednią nazwę?
    runs-on: ubuntu-latest
    needs: configure

    steps:
      - name: Validate branch name
        run: |
          set -euo pipefail
          EXPECTED_BRANCH="$GITHUB_REF_NAME"

          if [[ ! "$EXPECTED_BRANCH" =~ ^Zaliczenie2-[A-Za-z]+$ ]]; then
            echo "Branch name must be 'Zaliczenie2-ImieNazwisko' (ASCII, no spaces)"
            exit 1
          fi
